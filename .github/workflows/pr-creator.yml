
name: Create PR from Dev to Default Branch
on:
  workflow_dispatch:
  schedule:
    - cron: '30 18 * * 6'  # Runs every Saturday at midnight IST (adjust as needed)

env:
  TARGET_BRANCH: dev
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CONTINUE: true

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check if PR exists from '$TARGET_BRANCH' to default
      run: |
        PR_EXISTS=$(gh pr list --head "$TARGET_BRANCH" --state open --json number | jq -r '.[].number')
        
        if [ -n "$PR_EXISTS" ]; then
          echo "PR exists. Skipping PR creation."
          echo "CONTINUE=false" >> $GITHUB_ENV
        fi

    - name: Fetch default branch
      if: ${{ env.CONTINUE == 'true' }}
      run: |
        defaultBranch=$(gh repo view ${{ github.repository }} --json defaultBranchRef | jq -r '.defaultBranchRef.name')
        echo "Default branch is $defaultBranch"
        echo "DEFAULT_BRANCH=$defaultBranch" >> $GITHUB_ENV

    - name: Check if there are changes in the '$TARGET_BRANCH' branch
      if: ${{ env.CONTINUE == 'true' }}
      run: |
        git fetch

        git rev-list --left-right --count origin/$TARGET_BRANCH...origin/$DEFAULT_BRANCH 
        CHANGES_COUNT=$(git rev-list --left-right --count origin/$TARGET_BRANCH...origin/$DEFAULT_BRANCH | awk '{print $1}')

        if [ "$CHANGES_COUNT" -eq "0" ]; then
          echo "No changes in the '$TARGET_BRANCH' branch. Skipping PR creation."
          echo "CONTINUE=false" >> $GITHUB_ENV
        fi

    - name: Create PR
      if: ${{ env.CONTINUE == 'true' }}
      run: |
        # Create a PR from "$TARGET_BRANCH" to the default branch
        PR_URL=$(gh pr create --base "$DEFAULT_BRANCH" --head "$TARGET_BRANCH" --title "Auto-generated PR" -t "Auto-generated PR" -b "Auto-generated PR")
        echo "Created PR: $PR_URL"
